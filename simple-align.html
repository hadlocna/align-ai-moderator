<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Align - Simple & Reliable</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8fafc;
            margin: 0;
            padding: 20px;
            color: #334155;
            line-height: 1.6;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo {
            width: 200px;
            max-width: 80%;
            height: auto;
            margin-bottom: 20px;
        }
        input, textarea, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover {
            background: #4338ca;
        }
        button.secondary {
            background: #64748b;
        }
        button.secondary:hover {
            background: #475569;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success { background: #dcfce7; color: #166534; }
        .status.warning { background: #fef3c7; color: #92400e; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .hidden { display: none; }
        .text-small { font-size: 14px; color: #64748b; }
        .mt { margin-top: 20px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="Align_Logo.png" alt="Align" class="logo">
            <p class="text-small">A simple, reliable way to find agreement</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="card">
            <h2 id="loginTitle">Welcome to Align</h2>
            <p id="loginMessage">Enter your name to begin</p>
            <input type="text" id="userName" placeholder="Your name">
            <button id="loginBtn">Continue</button>
        </div>

        <!-- Topic Setup -->
        <div id="topicScreen" class="card hidden">
            <h2>What should we decide?</h2>
            <input type="text" id="topicInput" placeholder="e.g., Who watches the kids tonight?">
            <button id="createTopicBtn">Create Session</button>
            
            <div id="shareSection" class="hidden mt">
                <div class="status info">
                    <strong>Session Created!</strong><br>
                    Share this link: <br>
                    <input type="text" id="shareLink" readonly onclick="this.select()">
                </div>
                <button id="continueBtn">Continue to Agreement</button>
            </div>
        </div>

        <!-- Topic Agreement -->
        <div id="agreementScreen" class="card hidden">
            <h2>Topic Agreement</h2>
            <div class="status info">
                <strong>Topic:</strong> <span id="topicDisplay"></span>
            </div>
            <div id="partnerStatus"></div>
            <button id="agreeBtn">I Agree with This Topic</button>
            <textarea id="modifyInput" placeholder="Suggest a different topic..." class="hidden"></textarea>
            <button id="modifyBtn" class="secondary">Suggest Changes</button>
            <button id="submitModifyBtn" class="hidden">Submit Changes</button>
        </div>

        <!-- Private Inputs -->
        <div id="inputScreen" class="card hidden">
            <h2>Your Private Inputs</h2>
            <p class="text-small">Only you will see these details</p>
            
            <label>What's your ideal outcome?</label>
            <textarea id="objectives" placeholder="What would be the best result for you?"></textarea>
            
            <label>What are your must-haves?</label>
            <textarea id="mustHaves" placeholder="What is absolutely non-negotiable?"></textarea>
            
            <label>Any constraints or important facts?</label>
            <textarea id="constraints" placeholder="Budget, time limits, or other factors?"></textarea>
            
            <button id="submitInputsBtn">Continue to Agreement</button>
        </div>

        <!-- Results -->
        <div id="resultsScreen" class="card hidden">
            <h2>Proposed Agreement</h2>
            <div id="agreementResult"></div>
            <button id="downloadPdfBtn" class="mt">Download PDF</button>
            <button onclick="startOver()" class="mt">Start New Session</button>
        </div>

        <div id="statusBar" class="text-small mt"></div>
    </div>

    <script>
        // Simple localStorage-based session management
        let session = {
            id: null,
            userName: '',
            topic: '',
            isCreator: false,
            partnerName: '',
            agreed: false,
            partnerAgreed: false,
            userInputs: {}
        };

        // Generate simple session ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // Save session to localStorage
        function saveSession() {
            localStorage.setItem('align_session', JSON.stringify(session));
            if (session.id) {
                localStorage.setItem('align_session_' + session.id, JSON.stringify({
                    topic: session.topic,
                    creator: session.isCreator ? session.userName : session.partnerName,
                    participants: [session.userName, session.partnerName].filter(Boolean),
                    lastUpdate: Date.now()
                }));
            }
        }

        // Load session from localStorage
        function loadSession() {
            const saved = localStorage.getItem('align_session');
            if (saved) {
                session = {...session, ...JSON.parse(saved)};
            }
        }

        // Get session from URL
        function getUrlSession() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');
            const topic = params.get('topic');
            const creator = params.get('creator');
            const isInitiator = params.get('initiator') === 'true';
            
            if (sessionId && topic) {
                return {
                    id: sessionId,
                    topic: decodeURIComponent(topic),
                    creator: creator ? decodeURIComponent(creator) : '',
                    isInitiator: isInitiator
                };
            }
            return null;
        }

        // Show screen
        function showScreen(screenName) {
            document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenName).classList.remove('hidden');
        }

        // Update status
        function updateStatus(message, type = 'info') {
            const statusBar = document.getElementById('statusBar');
            statusBar.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusBar.innerHTML = '', 5000);
        }

        // Initialize app
        function init() {
            const urlSession = getUrlSession();
            
            if (urlSession) {
                // Joining or resuming session
                session.id = urlSession.id;
                session.topic = urlSession.topic;
                
                if (urlSession.isInitiator) {
                    // Returning creator
                    session.isCreator = true;
                    document.getElementById('loginTitle').textContent = 'Welcome Back!';
                    document.getElementById('loginMessage').textContent = `Your session: ${urlSession.topic}`;
                } else {
                    // Joining session
                    session.isCreator = false;
                    session.partnerName = urlSession.creator;
                    document.getElementById('loginTitle').textContent = 'Join Session';
                    document.getElementById('loginMessage').textContent = `Joining: ${urlSession.topic}`;
                }
            } else {
                // New session
                loadSession();
            }
            
            showScreen('loginScreen');
        }

        // Event listeners
        document.getElementById('loginBtn').addEventListener('click', () => {
            const name = document.getElementById('userName').value.trim();
            if (!name) {
                updateStatus('Please enter your name', 'warning');
                return;
            }
            
            session.userName = name;
            saveSession();
            
            if (session.id && !session.isCreator) {
                // Joining existing session
                proceedToAgreement();
            } else if (session.id && session.isCreator) {
                // Resuming creator session
                if (session.topic) {
                    proceedToAgreement();
                } else {
                    showScreen('topicScreen');
                }
            } else {
                // New session
                showScreen('topicScreen');
            }
        });

        document.getElementById('createTopicBtn').addEventListener('click', () => {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                updateStatus('Please enter a topic', 'warning');
                return;
            }
            
            session.id = generateId();
            session.topic = topic;
            session.isCreator = true;
            saveSession();
            
            // Create shareable URL
            const shareUrl = `${window.location.origin}${window.location.pathname}?session=${session.id}&topic=${encodeURIComponent(topic)}&creator=${encodeURIComponent(session.userName)}`;
            document.getElementById('shareLink').value = shareUrl;
            
            // Update URL for creator
            const creatorUrl = shareUrl + '&initiator=true';
            window.history.pushState({}, '', creatorUrl);
            
            document.getElementById('shareSection').classList.remove('hidden');
            updateStatus('Session created! Share the link with the other person.', 'success');
        });

        document.getElementById('continueBtn').addEventListener('click', () => {
            proceedToAgreement();
        });

        document.getElementById('agreeBtn').addEventListener('click', () => {
            session.agreed = true;
            saveSession();
            
            // In real app, this would sync with partner
            // For demo, simulate partner agreement after delay
            updateStatus('You agreed! Waiting for partner...', 'info');
            
            setTimeout(() => {
                session.partnerAgreed = true;
                updateStatus('Both agreed! Proceeding to private inputs...', 'success');
                setTimeout(() => showScreen('inputScreen'), 1000);
            }, 2000);
        });

        document.getElementById('modifyBtn').addEventListener('click', () => {
            document.getElementById('modifyInput').classList.remove('hidden');
            document.getElementById('submitModifyBtn').classList.remove('hidden');
        });

        document.getElementById('submitModifyBtn').addEventListener('click', () => {
            const newTopic = document.getElementById('modifyInput').value.trim();
            if (!newTopic) return;
            
            session.topic = newTopic;
            session.agreed = false;
            session.partnerAgreed = false;
            saveSession();
            
            document.getElementById('topicDisplay').textContent = newTopic;
            document.getElementById('modifyInput').classList.add('hidden');
            document.getElementById('submitModifyBtn').classList.add('hidden');
            updateStatus('Topic updated! Both users need to agree again.', 'info');
        });

        document.getElementById('submitInputsBtn').addEventListener('click', () => {
            session.userInputs = {
                objectives: document.getElementById('objectives').value,
                mustHaves: document.getElementById('mustHaves').value,
                constraints: document.getElementById('constraints').value
            };
            
            if (!session.userInputs.objectives || !session.userInputs.mustHaves || !session.userInputs.constraints) {
                updateStatus('Please fill in all fields', 'warning');
                return;
            }
            
            saveSession();
            
            // Generate simple agreement
            const agreement = `
                <h3>Proposed Agreement: ${session.topic}</h3>
                <p><strong>Approach:</strong> Based on both parties' needs, here's a fair solution that considers everyone's constraints and priorities.</p>
                <p><strong>Key Points:</strong></p>
                <ul>
                    <li>Addresses the main concerns raised by both parties</li>
                    <li>Respects non-negotiable requirements</li>
                    <li>Provides a practical implementation plan</li>
                </ul>
                <p><strong>Next Steps:</strong> Review this agreement and discuss any adjustments needed.</p>
            `;
            
            document.getElementById('agreementResult').innerHTML = agreement;
            showScreen('resultsScreen');
            updateStatus('Agreement generated!', 'success');
        });

        function proceedToAgreement() {
            document.getElementById('topicDisplay').textContent = session.topic;
            
            if (session.partnerName) {
                document.getElementById('partnerStatus').innerHTML = 
                    `<div class="status info">Partner: ${session.partnerName}</div>`;
            }
            
            showScreen('agreementScreen');
        }

        async function downloadAgreementPDF() {
            const { jsPDF } = window.jspdf;
            const temp = document.createElement('div');
            temp.style.padding = '20px';
            temp.innerHTML = `<h2>Proposed Agreement</h2>${document.getElementById('agreementResult').innerHTML}`;
            document.body.appendChild(temp);

            const canvas = await html2canvas(temp, { scale: 2 });
            document.body.removeChild(temp);

            const pdf = new jsPDF('p', 'pt', 'letter');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            const watermark = new Image();
            watermark.src = 'align-certified-watermark.png';
            await new Promise(resolve => watermark.onload = resolve);
            const wmWidth = pageWidth * 0.6;
            const wmHeight = watermark.height / watermark.width * wmWidth;
            pdf.setGState(new pdf.GState({ opacity: 0.1 }));
            pdf.addImage(watermark, 'PNG', (pageWidth - wmWidth) / 2, (pageHeight - wmHeight) / 2, wmWidth, wmHeight);
            pdf.setGState(new pdf.GState({ opacity: 1 }));

            const imgData = canvas.toDataURL('image/png');
            const imgProps = pdf.getImageProperties(imgData);
            const ratio = Math.min(pageWidth / imgProps.width, (pageHeight - 80) / imgProps.height);
            const pdfWidth = imgProps.width * ratio;
            const pdfHeight = imgProps.height * ratio;
            pdf.addImage(imgData, 'PNG', (pageWidth - pdfWidth) / 2, 40, pdfWidth, pdfHeight);

            pdf.save('agreement.pdf');
        }

        function startOver() {
            localStorage.removeItem('align_session');
            if (session.id) {
                localStorage.removeItem('align_session_' + session.id);
            }
            session = { id: null, userName: '', topic: '', isCreator: false, partnerName: '', agreed: false, partnerAgreed: false, userInputs: {} };
            window.history.pushState({}, '', window.location.pathname);
            location.reload();
        }

        document.getElementById('downloadPdfBtn').addEventListener('click', downloadAgreementPDF);

        // Initialize on load
        init();

        // Keep focused inputs visible on mobile when the on-screen keyboard appears
        document.querySelectorAll('input, textarea').forEach((el) => {
            el.addEventListener('focus', () => {
                setTimeout(() => {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });
        });
    </script>
</body>
</html>